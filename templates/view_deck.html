{% extends "base.html" %}

{% block title %}{{ deck['name'] }} - AI Flashcards{% endblock %}

{% block content %}
<div class="page-header">
    <h2>{{ deck['name'] }}</h2>
    <div class="header-actions">
        {% if due_count > 0 %}
            <a href="{{ url_for('study', deck_id=deck['id']) }}" class="btn btn-primary">Study ({{ due_count }} due)</a>
        {% endif %}
        <form method="POST" action="{{ url_for('delete_deck', deck_id=deck['id']) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this deck?');">
            <button type="submit" class="btn btn-danger">Delete Deck</button>
        </form>
    </div>
</div>

<div class="generate-section">
    <h3>Generate Flashcards</h3>
    <form id="generateForm" enctype="multipart/form-data">
        <div class="form-row">
            <div class="form-group">
                <label for="num_cards">Number of cards to generate</label>
                <input type="number" id="num_cards" name="num_cards" value="10" min="1" max="50" required>
            </div>
        </div>

        <div class="form-group">
            <label for="pdf_file">Upload PDF (optional)</label>
            <input type="file" id="pdf_file" name="pdf_file" accept=".pdf">
        </div>

        <div class="form-group">
            <label for="text_input">Or paste study material</label>
            <textarea id="text_input" name="text_input" rows="8" placeholder="Paste your study material here..."></textarea>
        </div>

        <div id="generateError" class="alert alert-error" style="display: none;"></div>
        <div id="generateSuccess" class="alert alert-success" style="display: none;"></div>

        <button type="submit" class="btn btn-primary" id="generateBtn">
            <span id="generateBtnText">Generate Flashcards</span>
            <span id="generateSpinner" style="display: none;">‚è≥ Generating...</span>
        </button>
    </form>
</div>

<div class="cards-section">
    <h3>Cards ({{ cards|length }})</h3>
    
    {% if cards %}
        <div class="cards-list">
            {% for card in cards %}
            <div class="card-item">
                <div class="card-content">
                    <div class="card-question">
                        <strong>Q:</strong> {{ card['question'] }}
                    </div>
                    <div class="card-answer">
                        <strong>A:</strong> {{ card['answer'] }}
                    </div>
                    <div class="card-meta">
                        Next review: {{ card['next_review'][:16] }}
                    </div>
                </div>
                <div class="card-actions">
                    <a href="{{ url_for('edit_card', card_id=card['id']) }}" class="btn btn-small">Edit</a>
                    <form method="POST" action="{{ url_for('delete_card', card_id=card['id']) }}" style="display: inline;" onsubmit="return confirm('Delete this card?');">
                        <button type="submit" class="btn btn-small btn-danger">Delete</button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state">
            <p>No cards yet. Generate some flashcards above!</p>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('generateForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const generateBtn = document.getElementById('generateBtn');
    const generateBtnText = document.getElementById('generateBtnText');
    const generateSpinner = document.getElementById('generateSpinner');
    const errorDiv = document.getElementById('generateError');
    const successDiv = document.getElementById('generateSuccess');
    
    // Disable button and show spinner
    generateBtn.disabled = true;
    generateBtnText.style.display = 'none';
    generateSpinner.style.display = 'inline';
    errorDiv.style.display = 'none';
    successDiv.style.display = 'none';
    
    try {
        const response = await fetch('{{ url_for("generate_cards", deck_id=deck["id"]) }}', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (response.ok) {
            successDiv.textContent = `Successfully generated ${data.count} flashcards!`;
            successDiv.style.display = 'block';
            
            // Reload page after 2 seconds
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            errorDiv.textContent = data.error || 'Failed to generate flashcards';
            errorDiv.style.display = 'block';
            generateBtn.disabled = false;
            generateBtnText.style.display = 'inline';
            generateSpinner.style.display = 'none';
        }
    } catch (error) {
        errorDiv.textContent = 'Network error. Please try again.';
        errorDiv.style.display = 'block';
        generateBtn.disabled = false;
        generateBtnText.style.display = 'inline';
        generateSpinner.style.display = 'none';
    }
});
</script>
{% endblock %}